<?php
// upload.php - Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
$uploadDir = 'sounds/';
$maxFileSize = 10 * 1024 * 1024; // 10MB
$allowedTypes = [
    'audio/mpeg' => 'mp3',
    'audio/wav' => 'wav',
    'audio/ogg' => 'ogg',
    'audio/x-wav' => 'wav',
    'audio/x-m4a' => 'm4a'
];

// Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø£ÙŠ Ù…ØµØ¯Ø± (Ù„ØªØ·ÙˆÙŠØ± Ù…Ø­Ù„ÙŠ)
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');
header('Content-Type: application/json; charset=utf-8');

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª OPTIONS
if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    http_response_code(200);
    exit();
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØµØ­ÙŠØ­
$log = date('Y-m-d H:i:s') . " - " . $_SERVER['REQUEST_METHOD'] . " " . $_SERVER['REQUEST_URI'] . "\n";
file_put_contents('upload_log.txt', $log, FILE_APPEND);

// ========== Ø¯Ø§Ù„Ø© GET Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ==========
if ($_SERVER['REQUEST_METHOD'] == 'GET') {
    if (isset($_GET['action']) && $_GET['action'] == 'list') {
        $files = [];
        if (is_dir($uploadDir)) {
            $fileList = scandir($uploadDir);
            foreach ($fileList as $file) {
                if ($file != '.' && $file != '..') {
                    $filePath = $uploadDir . $file;
                    $files[] = [
                        'name' => $file,
                        'path' => $filePath,
                        'size' => filesize($filePath),
                        'size_formatted' => formatBytes(filesize($filePath)),
                        'modified' => date('Y-m-d H:i:s', filemtime($filePath)),
                        'url' => $filePath
                    ];
                }
            }
        }
        
        echo json_encode([
            'success' => true,
            'count' => count($files),
            'files' => $files,
            'upload_dir' => realpath($uploadDir)
        ]);
        exit();
    }
    
    // ØµÙØ­Ø© HTML Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø±ÙØ¹
    if (!isset($_GET['api'])) {
        ?>
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª - Ù…Ù†ØµØ© Ø§Ù„ØªÙˆØ­Ø¯</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: 'Tahoma', sans-serif;
                    background: linear-gradient(135deg, #4a90e2 0%, #9013fe 100%);
                    min-height: 100vh;
                    padding: 20px;
                    color: #333;
                }
                .container {
                    max-width: 800px;
                    margin: 0 auto;
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                }
                h1 {
                    text-align: center;
                    color: #2c3e50;
                    margin-bottom: 30px;
                    font-size: 28px;
                }
                .upload-area {
                    border: 3px dashed #3498db;
                    border-radius: 10px;
                    padding: 40px 20px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                    margin-bottom: 20px;
                }
                .upload-area:hover {
                    background: #f8f9fa;
                    border-color: #2980b9;
                }
                .upload-area.dragover {
                    background: #e3f2fd;
                    border-color: #1a5276;
                }
                .upload-icon {
                    font-size: 48px;
                    color: #3498db;
                    margin-bottom: 10px;
                }
                .form-group {
                    margin: 20px 0;
                }
                label {
                    display: block;
                    margin-bottom: 8px;
                    font-weight: bold;
                    color: #2c3e50;
                }
                input[type="text"], select {
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 16px;
                    transition: border-color 0.3s;
                }
                input[type="text"]:focus, select:focus {
                    outline: none;
                    border-color: #3498db;
                }
                .upload-btn {
                    background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    font-size: 18px;
                    border-radius: 8px;
                    cursor: pointer;
                    width: 100%;
                    font-weight: bold;
                    transition: transform 0.3s;
                    margin-top: 20px;
                }
                .upload-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
                }
                .upload-btn:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                    transform: none;
                }
                .result {
                    margin-top: 20px;
                    padding: 20px;
                    border-radius: 10px;
                    display: none;
                }
                .success {
                    background: #d5edda;
                    color: #155724;
                    border: 1px solid #c3e6cb;
                }
                .error {
                    background: #f8d7da;
                    color: #721c24;
                    border: 1px solid #f5c6cb;
                }
                .files-list {
                    margin-top: 30px;
                    border-top: 2px solid #eee;
                    padding-top: 20px;
                }
                .file-item {
                    background: #f8f9fa;
                    padding: 15px;
                    margin: 10px 0;
                    border-radius: 8px;
                    border-left: 4px solid #3498db;
                }
                .file-name {
                    font-weight: bold;
                    color: #2c3e50;
                }
                .file-info {
                    color: #666;
                    font-size: 14px;
                    margin-top: 5px;
                }
                .play-btn {
                    background: #2ecc71;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 10px;
                }
                .delete-btn {
                    background: #e74c3c;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 10px;
                    margin-right: 10px;
                }
                .progress-bar {
                    height: 8px;
                    background: #e0e0e0;
                    border-radius: 4px;
                    margin: 15px 0;
                    overflow: hidden;
                    display: none;
                }
                .progress-fill {
                    height: 100%;
                    background: linear-gradient(90deg, #3498db, #2c3e50);
                    width: 0%;
                    transition: width 0.3s;
                }
                .server-info {
                    background: #f1f8ff;
                    padding: 15px;
                    border-radius: 8px;
                    margin-top: 20px;
                    font-size: 14px;
                    color: #666;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“¤ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª - Ù…Ù†ØµØ© Ø§Ù„ØªÙˆØ­Ø¯</h1>
                
                <div class="upload-area" id="dropArea">
                    <div class="upload-icon">ğŸµ</div>
                    <strong>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª Ù‡Ù†Ø§</strong><br>
                    <small>Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª (MP3, WAV, OGG, M4A)</small>
                    <input type="file" id="audioFile" accept="audio/*" multiple style="display: none;">
                </div>
                
                <div id="fileInfo" style="display: none;"></div>
                
                <div class="form-group">
                    <label for="category">Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
                    <select id="category">
                        <option value="">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Ù‹</option>
                        <option value="letters">Ø£Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="numbers">Ø£Ø±Ù‚Ø§Ù…</option>
                        <option value="animals">Ø­ÙŠÙˆØ§Ù†Ø§Øª</option>
                        <option value="objects">Ø£Ø´ÙŠØ§Ø¡</option>
                        <option value="words">ÙƒÙ„Ù…Ø§Øª</option>
                        <option value="songs">Ø£Ù†Ø§Ø´ÙŠØ¯</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="description">ÙˆØµÙ Ø§Ù„Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <input type="text" id="description" placeholder="Ù…Ø«Ø§Ù„: ØµÙˆØª Ø§Ù„Ø­Ø±Ù Ø£">
                </div>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <button class="upload-btn" id="uploadBtn" onclick="startUpload()">Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ğŸš€</button>
                
                <div id="result" class="result"></div>
                
                <div class="files-list">
                    <h3>ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©:</h3>
                    <div id="filesContainer">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª...</div>
                </div>
                
                <div class="server-info">
                    <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±:</strong><br>
                    Ø§Ù„Ù…Ø³Ø§Ø±: <?php echo __DIR__; ?><br>
                    Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±ÙØ¹: <?php echo realpath($uploadDir); ?>
                </div>
            </div>
            
            <script>
            // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            let selectedFiles = [];
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('audioFile');
            const fileInfo = document.getElementById('fileInfo');
            const uploadBtn = document.getElementById('uploadBtn');
            const resultDiv = document.getElementById('result');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const filesContainer = document.getElementById('filesContainer');
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('dragover');
                }, false);
            });
            
            dropArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
            
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
            
            function handleFiles(files) {
                selectedFiles = Array.from(files);
                
                if (selectedFiles.length === 0) return;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
                const validFiles = [];
                const errors = [];
                
                selectedFiles.forEach(file => {
                    const fileSizeMB = (file.size / (1024*1024)).toFixed(2);
                    
                    if (file.size > 10 * 1024 * 1024) {
                        errors.push(`âŒ ${file.name}: Ø§Ù„Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (${fileSizeMB} MB)`);
                    } else if (!file.type.startsWith('audio/')) {
                        errors.push(`âŒ ${file.name}: Ù„ÙŠØ³ Ù…Ù„Ù ØµÙˆØªÙŠ`);
                    } else {
                        validFiles.push(file);
                    }
                });
                
                if (errors.length > 0) {
                    showResult('error', errors.join('<br>'));
                }
                
                if (validFiles.length > 0) {
                    selectedFiles = validFiles;
                    displayFileInfo();
                } else {
                    selectedFiles = [];
                    fileInfo.style.display = 'none';
                }
            }
            
            function displayFileInfo() {
                let html = '<strong>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</strong><br>';
                selectedFiles.forEach(file => {
                    const fileSizeMB = (file.size / (1024*1024)).toFixed(2);
                    html += `ğŸ“ ${file.name} (${fileSizeMB} MB)<br>`;
                });
                fileInfo.innerHTML = html;
                fileInfo.style.display = 'block';
            }
            
            // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
            async function startUpload() {
                if (selectedFiles.length === 0) {
                    showResult('error', 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }
                
                const category = document.getElementById('category').value;
                const description = document.getElementById('description').value;
                
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
                progressBar.style.display = 'block';
                resultDiv.style.display = 'none';
                
                const results = [];
                const totalFiles = selectedFiles.length;
                
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = ((i / totalFiles) * 100).toFixed(0);
                    progressFill.style.width = progress + '%';
                    
                    const result = await uploadFile(file, category, description);
                    results.push(result);
                }
                
                progressFill.style.width = '100%';
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                const successful = results.filter(r => r.success).length;
                const failed = results.filter(r => !r.success).length;
                
                let resultHtml = '';
                if (successful > 0) {
                    resultHtml += `<strong>âœ… ØªÙ… Ø±ÙØ¹ ${successful} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­</strong><br>`;
                    results.filter(r => r.success).forEach(r => {
                        resultHtml += `ğŸ“ ${r.file_name}<br>`;
                    });
                }
                
                if (failed > 0) {
                    resultHtml += `<br><strong>âŒ ÙØ´Ù„ Ø±ÙØ¹ ${failed} Ù…Ù„Ù</strong><br>`;
                    results.filter(r => !r.success).forEach(r => {
                        resultHtml += `âŒ ${r.message}<br>`;
                    });
                }
                
                showResult(successful > 0 ? 'success' : 'error', resultHtml);
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ğŸš€';
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
                loadFiles();
            }
            
            async function uploadFile(file, category, description) {
                const formData = new FormData();
                formData.append('audioFile', file);
                formData.append('category', category);
                formData.append('description', description);
                
                try {
                    const response = await fetch('upload.php?api=1', {
                        method: 'POST',
                        body: formData
                    });
                    
                    return await response.json();
                } catch (error) {
                    return {
                        success: false,
                        message: `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`
                    };
                }
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
            async function loadFiles() {
                try {
                    const response = await fetch('upload.php?action=list');
                    const data = await response.json();
                    
                    if (data.success) {
                        if (data.files.length === 0) {
                            filesContainer.innerHTML = '<p style="color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø±ÙÙˆØ¹Ø© Ø¨Ø¹Ø¯</p>';
                            return;
                        }
                        
                        let html = '';
                        data.files.forEach(file => {
                            html += `
                                <div class="file-item">
                                    <div class="file-name">ğŸµ ${file.name}</div>
                                    <div class="file-info">
                                        Ø§Ù„Ø­Ø¬Ù…: ${file.size_formatted} | 
                                        Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ${file.modified}
                                    </div>
                                    <button class="play-btn" onclick="playAudio('${file.url}')">â–¶ ØªØ´ØºÙŠÙ„</button>
                                    <button class="delete-btn" onclick="deleteFile('${file.name}')">ğŸ—‘ Ø­Ø°Ù</button>
                                    <a href="${file.url}" download style="text-decoration: none;">
                                        <button style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                            â¬‡ ØªØ­Ù…ÙŠÙ„
                                        </button>
                                    </a>
                                </div>
                            `;
                        });
                        
                        filesContainer.innerHTML = html;
                    }
                } catch (error) {
                    filesContainer.innerHTML = `<p style="color: red;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª: ${error.message}</p>`;
                }
            }
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
            function playAudio(url) {
                const audio = new Audio(url);
                audio.play().catch(e => {
                    showResult('error', 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
                });
            }
            
            // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù
            async function deleteFile(fileName) {
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù "${fileName}"ØŸ`)) return;
                
                try {
                    const response = await fetch(`upload.php?action=delete&file=${encodeURIComponent(fileName)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        showResult('success', `âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù "${fileName}"`);
                        loadFiles();
                    } else {
                        showResult('error', data.message);
                    }
                } catch (error) {
                    showResult('error', `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ${error.message}`);
                }
            }
            
            function showResult(type, message) {
                resultDiv.className = `result ${type}`;
                resultDiv.innerHTML = message;
                resultDiv.style.display = 'block';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            window.onload = function() {
                loadFiles();
            };
            </script>
        </body>
        </html>
        <?php
        exit();
    }
}

// ========== Ø¯Ø§Ù„Ø© POST Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ==========
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
    if (!isset($_FILES['audioFile'])) {
        echo json_encode([
            'success' => false,
            'message' => 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ù…Ù„Ù'
        ]);
        exit();
    }
    
    $file = $_FILES['audioFile'];
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    if ($file['error'] !== UPLOAD_ERR_OK) {
        $errorMessages = [
            1 => 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­',
            2 => 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø­Ø¯ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬',
            3 => 'ØªÙ… Ø±ÙØ¹ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·',
            4 => 'Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ù…Ù„Ù',
            6 => 'Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø¤Ù‚Øª Ù…ÙÙ‚ÙˆØ¯',
            7 => 'ÙØ´Ù„ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù',
            8 => 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¥Ø¶Ø§ÙØ© PHP'
        ];
        
        echo json_encode([
            'success' => false,
            'message' => $errorMessages[$file['error']] ?? 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø±ÙØ¹'
        ]);
        exit();
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù…
    if ($file['size'] > $maxFileSize) {
        echo json_encode([
            'success' => false,
            'message' => 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª'
        ]);
        exit();
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ÙˆØ¹
    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $mimeType = finfo_file($finfo, $file['tmp_name']);
    finfo_close($finfo);
    
    if (!array_key_exists($mimeType, $allowedTypes)) {
        echo json_encode([
            'success' => false,
            'message' => 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª'
        ]);
        exit();
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±ÙØ¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (!is_dir($uploadDir)) {
        mkdir($uploadDir, 0777, true);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ù…Ù„Ù ÙØ±ÙŠØ¯
    $category = $_POST['category'] ?? '';
    $description = $_POST['description'] ?? '';
    
    $originalName = pathinfo($file['name'], PATHINFO_FILENAME);
    $extension = $allowedTypes[$mimeType];
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù…
    $cleanName = preg_replace('/[^a-zA-Z0-9Ø§Ø£Ø¥Ø¢Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠÙ‰Ø¡-]+/u', '_', $originalName);
    
    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    if (!empty($description)) {
        $fileName = preg_replace('/[^a-zA-Z0-9Ø§Ø£Ø¥Ø¢Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠÙ‰Ø¡-]+/u', '_', $description);
    } else {
        $fileName = $cleanName;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    $counter = 1;
    $finalName = $fileName . '.' . $extension;
    while (file_exists($uploadDir . $finalName)) {
        $finalName = $fileName . '_' . $counter . '.' . $extension;
        $counter++;
    }
    
    // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
    $targetPath = $uploadDir . $finalName;
    
    if (move_uploaded_file($file['tmp_name'], $targetPath)) {
        // ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù
        $fileInfo = [
            'name' => $finalName,
            'original_name' => $file['name'],
            'size' => $file['size'],
            'type' => $mimeType,
            'category' => $category,
            'description' => $description,
            'upload_date' => date('Y-m-d H:i:s'),
            'upload_ip' => $_SERVER['REMOTE_ADDR']
        ];
        
        file_put_contents($uploadDir . 'files.json', json_encode($fileInfo, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        
        echo json_encode([
            'success' => true,
            'message' => 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­',
            'file_name' => $finalName,
            'file_path' => $targetPath,
            'file_size' => formatBytes($file['size']),
            'file_size_bytes' => $file['size'],
            'category' => $category,
            'description' => $description,
            'upload_date' => date('Y-m-d H:i:s')
        ]);
    } else {
        echo json_encode([
            'success' => false,
            'message' => 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…'
        ]);
    }
    
    exit();
}

// ========== Ø¯Ø§Ù„Ø© DELETE Ù„Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª ==========
if ($_SERVER['REQUEST_METHOD'] == 'GET' && isset($_GET['action']) && $_GET['action'] == 'delete' && isset($_GET['file'])) {
    $fileName = basename($_GET['file']);
    $filePath = $uploadDir . $fileName;
    
    if (file_exists($filePath) && unlink($filePath)) {
        echo json_encode([
            'success' => true,
            'message' => 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­'
        ]);
    } else {
        echo json_encode([
            'success' => false,
            'message' => 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù'
        ]);
    }
    exit();
}

// ========== Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ø¬Ù… ==========
function formatBytes($bytes, $precision = 2) {
    $units = ['Ø¨Ø§ÙŠØª', 'Ùƒ.Ø¨', 'Ù….Ø¨', 'Ø¬.Ø¨', 'Øª.Ø¨'];
    $bytes = max($bytes, 0);
    $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
    $pow = min($pow, count($units) - 1);
    $bytes /= pow(1024, $pow);
    return round($bytes, $precision) . ' ' . $units[$pow];
}
?>